from enum import IntEnum, StrEnum

from pydantic import BaseModel

from sekoia_automation.asset_connector.models.ocsf.base import OCSFBaseModel, Product
from sekoia_automation.asset_connector.models.ocsf.device import Device


class KillChainPhase(StrEnum):
    UNKNOWN = "Unknown"
    RECONNAISSANCE = "Reconnaissance"
    WEAPONIZATION = "Weaponization"
    DELIVERY = "Delivery"
    EXPLOITATION = "Exploitation"
    INSTALLATION = "Installation"
    COMMAND_AND_CONTROL = "Command & Control"
    ACTIONS_ON_OBJECTIVES = "Actions on Objectives"
    OTHER = "Other"


class KillChainPhaseID(IntEnum):
    UNKNOWN = 0
    RECONNAISSANCE = 1
    WEAPONIZATION = 2
    DELIVERY = 3
    EXPLOITATION = 4
    INSTALLATION = 5
    COMMAND_AND_CONTROL = 6
    ACTIONS_ON_OBJECTIVES = 7
    OTHER = 99


class KillChain(BaseModel):
    phase: KillChainPhase
    phase_id: KillChainPhaseID | None = None


class MITREAttackTactic(BaseModel):
    name: str | None = None
    src_url: str | None = None
    uid: str | None = None


class MITREAttackTechnique(BaseModel):
    name: str | None = None
    src_url: str | None = None
    uid: str | None = None


class MITREAttack(BaseModel):
    version: str | None = None
    tactic: MITREAttackTactic | None = None
    technique: MITREAttackTechnique | None = None


class FindingInformation(BaseModel):
    """
    FindingInformation model represents the information about a vulnerability finding.
    https://schema.ocsf.io/1.5.0/objects/finding_information
    """

    uid: str
    data_sources: list[str] | None = None
    title: str | None = None
    src_url: str | None = None
    kill_chain: list[KillChain] | None = None
    desc: str | None = None
    last_seen_time: int | None = None
    first_seen_time: int | None = None
    created_time: int | None = None
    attacks: list[MITREAttack] | None = None
    types: list[str] | None = None
    product: Product | None = None


class CVSS(BaseModel):
    version: str
    base_score: float | None = None


class CVE(BaseModel):
    uid: str
    type: str | None = None
    cvss: list[CVSS] | None = None
    desc: str | None = None
    title: str | None = None


class VulnerabilityDetails(BaseModel):
    title: str | None = None
    desc: str | None = None
    references: list[str] | None = None
    cve: CVE | None = None
    severity: str | None = None
    vendor_name: str | None = None


# https://schema.ocsf.io/1.5.0/classes/vulnerability_finding
class VulnerabilityOCSFModel(OCSFBaseModel):
    device: Device | None = None
    finding_info: FindingInformation
    vulnerabilities: VulnerabilityDetails
    time: int
    confidence: str | None = None
    confidence_id: int | None = None
    confidence_score: int | None = None
